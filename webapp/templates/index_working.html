<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Scissor Stone ML Game</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .move-btn { 
            padding: 15px 20px; 
            margin: 10px; 
            font-size: 16px; 
            cursor: pointer; 
            border: 2px solid #4CAF50; 
            background: #4CAF50; 
            color: white; 
            border-radius: 8px; 
        }
        .move-btn:hover { 
            background: #45a049; 
        }
        .result { 
            margin: 20px 0; 
            padding: 20px; 
            background: #e8f5e8; 
            border-radius: 8px; 
            border-left: 4px solid #4CAF50; 
        }
        .stats { 
            display: flex; 
            gap: 20px; 
            margin: 20px 0; 
        }
        .stat-card { 
            flex: 1; 
            padding: 15px; 
            background: #fff3e0; 
            border-radius: 8px; 
            text-align: center; 
        }
        .current-strategy { 
            text-align: center; 
            margin: 20px 0; 
            padding: 15px; 
            background: #fff3e0; 
            border-radius: 10px; 
            border-left: 4px solid #ff9800; 
        }
        .controls { 
            text-align: center; 
            margin: 20px 0; 
        }
        select, input { 
            margin: 5px 10px; 
            padding: 5px; 
        }
        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #1976d2;
        }
        .move-bar {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .move-label {
            width: 80px;
            font-weight: bold;
            text-align: right;
        }
        .bar-container {
            flex: 1;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        .bar-percentage {
            width: 50px;
            text-align: left;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Paper Scissor Stone ML Game</h1>
        
        <div class="current-strategy">
            <strong>Current Strategy: </strong>
            <span id="current-strategy-text">Analyzing...</span>
        </div>
        
        <div class="controls">
            <label for="difficulty">Difficulty:</label>
            <select id="difficulty" onchange="setDifficulty()">
                <option value="enhanced" {{ 'selected' if default_difficulty == 'enhanced' else '' }}>Enhanced ML</option>
                <option value="frequency" {{ 'selected' if default_difficulty == 'frequency' else '' }}>Frequency</option>
                <option value="markov" {{ 'selected' if default_difficulty == 'markov' else '' }}>Markov</option>
                <option value="random" {{ 'selected' if default_difficulty == 'random' else '' }}>Random</option>
            </select>
            
            <label for="multiplayer">Multiplayer:</label>
            <input type="checkbox" id="multiplayer" onchange="setMultiplayer()">
            
            <div style="margin-top: 15px;">
                <h3>Make your move:</h3>
                <button type="button" id="move-paper" class="move-btn" onclick="submitMove('paper')">
                    Paper (P)
                </button>
                <button type="button" id="move-stone" class="move-btn" onclick="submitMove('stone')">
                    Rock (R)
                </button>
                <button type="button" id="move-scissor" class="move-btn" onclick="submitMove('scissor')">
                    Scissor (S)
                </button>
            </div>
            
            <button onclick="resetGame()" style="margin-top: 15px;">Reset Game</button>
        </div>
        
        <div id="result" class="result">
            Press buttons or use A, W, D keys to play!
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h4>Rounds</h4>
                <div id="rounds">{{ round }}</div>
            </div>
            <div class="stat-card">
                <h4>Your Wins</h4>
                <div id="human-wins">{{ stats.human_win }}</div>
            </div>
            <div class="stat-card">
                <h4>Computer Wins</h4>
                <div id="robot-wins">{{ stats.robot_win }}</div>
            </div>
            <div class="stat-card">
                <h4>Ties</h4>
                <div id="ties">{{ stats.tie }}</div>
            </div>
        </div>
        
        <div style="margin-top: 30px;">
            <h3>Recent History</h3>
            <p><strong>Your moves:</strong> <span id="recent-human">{{ human_history[-10:]|join(', ') }}</span></p>
            <p><strong>Computer moves:</strong> <span id="recent-robot">{{ robot_history[-10:]|join(', ') }}</span></p>
        </div>
        
        <!-- Coaching Tips Section -->
        <div style="margin-top: 30px;">
            <h3 style="color: #a86e3c;">üéì AI Coach - Personalized Tips</h3>
            <div style="display: flex; gap: 20px; margin-top: 15px;">
                <div style="flex: 2; background: #fff3e0; border-radius: 10px; padding: 20px; border-left: 4px solid #ff9800;">
                    <h4 style="color: #e65100; margin-top: 0; display: flex; align-items: center; justify-content: space-between;">
                        üí° Your Strategy Tips
                        <button onclick="refreshCoachingTips()" style="padding: 8px 15px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                            üîÑ Get New Tips
                        </button>
                    </h4>
                    <div id="coaching-tips-list" style="line-height: 1.6;">
                        <p style="color: #666; font-style: italic;">Play a few rounds to get personalized coaching tips!</p>
                    </div>
                </div>
                <div style="flex: 1; background: #e8f5e8; border-radius: 10px; padding: 20px; border-left: 4px solid #4caf50;">
                    <h4 style="color: #2e7d32; margin-top: 0;">üß™ Experiments to Try</h4>
                    <div id="experiments-list" style="line-height: 1.5;">
                        <p style="color: #666; font-style: italic;">Suggested strategies will appear here!</p>
                    </div>
                </div>
            </div>
            <div id="insights-summary" style="margin-top: 15px; padding: 15px; background: #f3e5f5; border-radius: 8px; border-left: 4px solid #9c27b0; display: none;">
                <h4 style="color: #6a1b9a; margin-top: 0;">üìä Pattern Analysis</h4>
                <div id="insights-content" style="font-size: 14px; color: #4a148c;"></div>
            </div>
        </div>
        
        <!-- Advanced Analytics Dashboard -->
        <div style="margin-top: 40px;">
            <h3 style="color: #1976d2;">üìä Advanced Analytics Dashboard</h3>
            
            <!-- Strategy Metrics Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                <div class="analytics-card">
                    <h4 style="color: #1976d2; margin: 0 0 10px 0;">üéØ Predictability Score</h4>
                    <div id="predictability-score" style="font-size: 24px; font-weight: bold; color: #1976d2;">--</div>
                    <div id="predictability-status" style="font-size: 12px; color: #666; margin-top: 5px;">Analyzing...</div>
                </div>
                
                <div class="analytics-card">
                    <h4 style="color: #388e3c; margin: 0 0 10px 0;">üèÜ Win Rate Trend</h4>
                    <div id="win-rate-trend" style="font-size: 24px; font-weight: bold; color: #388e3c;">--</div>
                    <div id="trend-status" style="font-size: 12px; color: #666; margin-top: 5px;">Recent 10 games</div>
                </div>
                
                <div class="analytics-card">
                    <h4 style="color: #f57c00; margin: 0 0 10px 0;">üîÑ Strategy Changes</h4>
                    <div id="strategy-changes-count" style="font-size: 24px; font-weight: bold; color: #f57c00;">--</div>
                    <div id="changes-status" style="font-size: 12px; color: #666; margin-top: 5px;">Adaptability</div>
                </div>
                
                <div class="analytics-card">
                    <h4 style="color: #7b1fa2; margin: 0 0 10px 0;">üé≤ Randomness Level</h4>
                    <div id="randomness-level" style="font-size: 24px; font-weight: bold; color: #7b1fa2;">--</div>
                    <div id="randomness-status" style="font-size: 12px; color: #666; margin-top: 5px;">Unpredictability</div>
                </div>
            </div>
            
            <!-- Move Distribution -->
            <div style="margin-top: 30px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <h4 style="color: #1976d2; margin-top: 0;">üìà Move Distribution Analysis</h4>
                <div style="display: flex; gap: 20px; align-items: center;">
                    <div style="flex: 1;">
                        <div id="paper-bar" class="move-bar">
                            <div class="move-label">Paper (P)</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="paper-fill" style="width: 0%; background: #4caf50;"></div>
                            </div>
                            <div class="bar-percentage" id="paper-percent">0%</div>
                        </div>
                        <div id="rock-bar" class="move-bar">
                            <div class="move-label">Rock (R)</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="rock-fill" style="width: 0%; background: #ff9800;"></div>
                            </div>
                            <div class="bar-percentage" id="rock-percent">0%</div>
                        </div>
                        <div id="scissor-bar" class="move-bar">
                            <div class="move-label">Scissor (S)</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="scissor-fill" style="width: 0%; background: #f44336;"></div>
                            </div>
                            <div class="bar-percentage" id="scissor-percent">0%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export and Actions -->
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="exportAnalytics('json')" style="padding: 10px 20px; margin: 5px; background: #1976d2; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    üìÑ Export JSON Report
                </button>
                <button onclick="refreshAnalytics()" style="padding: 10px 20px; margin: 5px; background: #388e3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    üîÑ Refresh Analytics
                </button>
                <button onclick="showDeveloperMetrics()" style="padding: 10px 20px; margin: 5px; background: #7b1fa2; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    üîß Developer Metrics
                </button>
            </div>
        </div>
    </div>

    <script>
        console.log('Main page script loading...');
        
        // Global variables
        let currentDifficulty = '{{ default_difficulty }}';
        let currentMultiplayer = false;
        
        // Keyboard controls
        document.addEventListener('keydown', function(e) {
            console.log('Key pressed:', e.key);
            if (e.key === 'p' || e.key === 'P') submitMove('paper');
            if (e.key === 'r' || e.key === 'R') submitMove('stone'); // Rock = Stone
            if (e.key === 's' || e.key === 'S') submitMove('scissor');
        });
        
        // Game functions
        function submitMove(move) {
            console.log('submitMove called with:', move);
            
            const payload = {
                move: move,
                difficulty: currentDifficulty,
                multiplayer: currentMultiplayer
            };
            
            if (currentMultiplayer) {
                let move2 = prompt('Player 2, choose paper, scissor, or stone:');
                if (!['paper','scissor','stone'].includes(move2)) {
                    alert('Invalid move for Player 2.');
                    return;
                }
                payload.move2 = move2;
            }
            
            console.log('Sending payload:', payload);
            
            fetch('/play', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => {
                console.log('Response status:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('Received data:', data);
                updateUI(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('result').innerHTML = 
                    '<p style="color: red;">Error: ' + error.message + '</p>';
            });
        }
        
        function updateUI(data) {
            console.log('Updating UI with:', data);
            
            // Safely get the last human move
            const lastHumanMove = data.human_history && data.human_history.length > 0 
                ? data.human_history[data.human_history.length-1] 
                : 'unknown';
            
            // Safely get the robot move
            const robotMove = data.robot_move || 'unknown';
            
            // Safely get the result
            const result = data.result ? String(data.result) : 'unknown';
            
            // Update result
            document.getElementById('result').innerHTML = 
                '<h3>Round ' + (data.round || 0) + ' Results</h3>' +
                '<p>You played: <strong>' + lastHumanMove.toUpperCase() + '</strong></p>' +
                '<p>Computer played: <strong>' + robotMove.toUpperCase() + '</strong></p>' +
                '<p>Result: <strong>' + result.toUpperCase() + '</strong></p>';
            
            // Update stats safely
            const stats = data.stats || {};
            document.getElementById('rounds').textContent = data.round || 0;
            document.getElementById('human-wins').textContent = stats.human_win || 0;
            document.getElementById('robot-wins').textContent = stats.robot_win || 0;
            document.getElementById('ties').textContent = stats.tie || 0;
            
            // Update recent history safely
            const recentHuman = data.human_history ? data.human_history.slice(-10).join(', ') : '';
            const recentRobot = data.robot_history ? data.robot_history.slice(-10).join(', ') : '';
            document.getElementById('recent-human').textContent = recentHuman;
            document.getElementById('recent-robot').textContent = recentRobot;
            
            // Update strategy display
            if (data.current_strategy) {
                const strategy = String(data.current_strategy);
                document.getElementById('current-strategy-text').textContent = 
                    strategy.charAt(0).toUpperCase() + strategy.slice(1);
            }
            
            // Auto-refresh coaching tips every 5 rounds
            if (data.round && data.round > 0 && data.round % 5 === 0) {
                setTimeout(refreshCoachingTips, 500); // Small delay to ensure data is processed
            }
            
            // Update analytics dashboard
            updateAnalyticsDashboard(data);
        }
        
        // Advanced Analytics Functions
        function updateAnalyticsDashboard(data) {
            if (!data.human_history || data.human_history.length === 0) return;
            
            const history = data.human_history;
            const totalMoves = history.length;
            
            // Calculate move distribution
            const paperCount = history.filter(m => m === 'paper').length;
            const stoneCount = history.filter(m => m === 'stone').length;
            const scissorCount = history.filter(m => m === 'scissor').length;
            
            const paperPercent = ((paperCount / totalMoves) * 100).toFixed(1);
            const stonePercent = ((stoneCount / totalMoves) * 100).toFixed(1);
            const scissorPercent = ((scissorCount / totalMoves) * 100).toFixed(1);
            
            // Update move distribution bars
            document.getElementById('paper-fill').style.width = paperPercent + '%';
            document.getElementById('rock-fill').style.width = stonePercent + '%';
            document.getElementById('scissor-fill').style.width = scissorPercent + '%';
            
            document.getElementById('paper-percent').textContent = paperPercent + '%';
            document.getElementById('rock-percent').textContent = stonePercent + '%';
            document.getElementById('scissor-percent').textContent = scissorPercent + '%';
            
            // Calculate predictability score
            const maxPercent = Math.max(paperPercent, stonePercent, scissorPercent);
            const predictabilityScore = maxPercent;
            document.getElementById('predictability-score').textContent = predictabilityScore + '%';
            
            let predictabilityStatus = 'Highly Unpredictable';
            if (predictabilityScore > 50) predictabilityStatus = 'Somewhat Predictable';
            if (predictabilityScore > 70) predictabilityStatus = 'Very Predictable';
            document.getElementById('predictability-status').textContent = predictabilityStatus;
            
            // Calculate recent win rate trend
            const recentGames = Math.min(10, data.round);
            const recentWins = data.stats ? data.stats.human_win : 0;
            const winRate = data.round > 0 ? ((recentWins / data.round) * 100).toFixed(1) : 0;
            document.getElementById('win-rate-trend').textContent = winRate + '%';
            
            // Calculate randomness level (entropy)
            const p1 = paperCount / totalMoves;
            const p2 = stoneCount / totalMoves;
            const p3 = scissorCount / totalMoves;
            let entropy = 0;
            if (p1 > 0) entropy -= p1 * Math.log2(p1);
            if (p2 > 0) entropy -= p2 * Math.log2(p2);
            if (p3 > 0) entropy -= p3 * Math.log2(p3);
            const randomnessPercent = ((entropy / Math.log2(3)) * 100).toFixed(1);
            document.getElementById('randomness-level').textContent = randomnessPercent + '%';
            
            let randomnessStatus = 'Low Randomness';
            if (randomnessPercent > 60) randomnessStatus = 'Medium Randomness';
            if (randomnessPercent > 80) randomnessStatus = 'High Randomness';
            document.getElementById('randomness-status').textContent = randomnessStatus;
            
            // Strategy changes (placeholder)
            document.getElementById('strategy-changes-count').textContent = Math.floor(data.round / 7) || 0;
        }
        
        function refreshAnalytics() {
            console.log('Refreshing analytics...');
            fetch('/history')
            .then(res => res.json())
            .then(data => {
                console.log('Analytics data received:', data);
                updateAnalyticsDashboard(data);
            })
            .catch(err => console.log('Analytics refresh failed:', err));
        }
        
        function exportAnalytics(format) {
            console.log('Exporting analytics in format:', format);
            fetch('/analytics/export?format=' + format)
            .then(res => res.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'rps_analytics_' + new Date().toISOString().split('T')[0] + '.' + format;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(err => {
                console.log('Export failed, creating manual export:', err);
                // Fallback: create manual JSON export
                const analyticsData = {
                    timestamp: new Date().toISOString(),
                    total_games: parseInt(document.getElementById('rounds').textContent) || 0,
                    predictability_score: document.getElementById('predictability-score').textContent,
                    win_rate: document.getElementById('win-rate-trend').textContent,
                    randomness_level: document.getElementById('randomness-level').textContent,
                    move_distribution: {
                        paper: document.getElementById('paper-percent').textContent,
                        rock: document.getElementById('rock-percent').textContent,
                        scissor: document.getElementById('scissor-percent').textContent
                    }
                };
                const dataStr = JSON.stringify(analyticsData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'rps_analytics_' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
            });
        }
        
        function showDeveloperMetrics() {
            const metrics = {
                'Page Load Time': 'Fast',
                'API Response Time': 'Good',
                'JavaScript Errors': 'None',
                'Memory Usage': 'Normal',
                'Network Requests': 'Optimized'
            };
            
            let metricsHtml = '<h4>üîß Developer Metrics Console</h4>';
            for (const [key, value] of Object.entries(metrics)) {
                metricsHtml += `<p><strong>${key}:</strong> ${value}</p>`;
            }
            metricsHtml += '<p><em>All systems operational</em></p>';
            
            alert('Developer Metrics:\n\n' + Object.entries(metrics).map(([k,v]) => `${k}: ${v}`).join('\n'));
        }
        
        // Coaching Functions
        function refreshCoachingTips() {
            console.log('Refreshing coaching tips...');
            fetch('/coaching')
            .then(res => res.json())
            .then(data => {
                console.log('Coaching data received:', data);
                updateCoachingTips(data);
            })
            .catch(err => {
                console.log('Coaching tips unavailable:', err);
                document.getElementById('coaching-tips-list').innerHTML = 
                    '<p style="color: #666; font-style: italic;">Coaching tips will be available after more games.</p>';
            });
        }
        
        function updateCoachingTips(coachingData) {
            const tipsContainer = document.getElementById('coaching-tips-list');
            const experimentsContainer = document.getElementById('experiments-list');
            const insightsContainer = document.getElementById('insights-content');
            const insightsSummary = document.getElementById('insights-summary');
            
            // Update tips
            if (coachingData.coaching_tips && coachingData.coaching_tips.length > 0) {
                const tipsHtml = coachingData.coaching_tips.map((tip, index) => 
                    `<div style="margin-bottom: 12px; padding: 10px; background: rgba(255,152,0,0.1); border-radius: 6px;">
                        <strong>${index + 1}.</strong> ${tip}
                    </div>`
                ).join('');
                tipsContainer.innerHTML = tipsHtml;
            } else {
                tipsContainer.innerHTML = '<p style="color: #666; font-style: italic;">Keep playing to get personalized tips!</p>';
            }
            
            // Update experiments
            if (coachingData.experiments && coachingData.experiments.length > 0) {
                const experimentsHtml = coachingData.experiments.map(exp => 
                    `<div style="margin-bottom: 15px; padding: 12px; background: rgba(76,175,80,0.1); border-radius: 6px;">
                        <strong style="color: #2e7d32;">${exp.name}</strong><br>
                        <small style="color: #388e3c;">${exp.description}</small><br>
                        <em style="font-size: 13px; color: #4caf50;">${exp.strategy}</em>
                    </div>`
                ).join('');
                experimentsContainer.innerHTML = experimentsHtml;
            } else {
                experimentsContainer.innerHTML = '<p style="color: #666; font-style: italic;">Experiment suggestions coming soon!</p>';
            }
            
            // Update insights (optional)
            if (coachingData.insights && Object.keys(coachingData.insights).length > 0) {
                const insights = coachingData.insights;
                let insightsHtml = '';
                
                if (insights.predictability !== undefined) {
                    const predPercent = (insights.predictability * 100).toFixed(1);
                    insightsHtml += `<p><strong>Predictability:</strong> ${predPercent}% - `;
                    insightsHtml += insights.predictability > 0.6 ? 'Too predictable!' : 'Good unpredictability';
                    insightsHtml += '</p>';
                }
                
                if (insights.pattern_type) {
                    insightsHtml += `<p><strong>Pattern Type:</strong> ${insights.pattern_type.replace('_', ' ')}</p>`;
                }
                
                if (insights.recent_performance) {
                    const winRate = (insights.recent_performance.win_rate * 100).toFixed(1);
                    insightsHtml += `<p><strong>Recent Win Rate:</strong> ${winRate}%</p>`;
                }
                
                if (insightsHtml) {
                    insightsContainer.innerHTML = insightsHtml;
                    insightsSummary.style.display = 'block';
                } else {
                    insightsSummary.style.display = 'none';
                }
            } else {
                insightsSummary.style.display = 'none';
            }
        }
        
        function setDifficulty() {
            currentDifficulty = document.getElementById('difficulty').value;
            console.log('Difficulty set to:', currentDifficulty);
        }
        
        function setMultiplayer() {
            currentMultiplayer = document.getElementById('multiplayer').checked;
            console.log('Multiplayer set to:', currentMultiplayer);
        }
        
        function resetGame() {
            fetch('/reset', {method: 'POST'})
            .then(res => res.json())
            .then(() => location.reload())
            .catch(error => {
                console.error('Reset error:', error);
                location.reload();
            });
        }
        
        console.log('Main page script loaded successfully');
    </script>
</body>
</html>