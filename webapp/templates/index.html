<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Paper Scissor Stone ML Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 24px 32px;
        }
        h1 {
            font-size: 2rem;
            margin-bottom: 0.5em;
        }
        .move-btn {
            font-size: 1.2em;
            margin: 0.5em;
            padding: 0.5em 1em;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #f0f0f0;
            transition: background 0.2s;
        }
        .move-btn:hover {
            background: #e0e0e0;
        }
        .hotkey {
            font-size: 0.9em;
            color: #888;
        }
        #result {
            font-size: 1.1em;
            margin: 1em 0;
            color: #1976d2;
        }
        #stats {
            margin-top: 2em;
            padding: 1em;
            background: #fafafa;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .chart-container {
            max-width: 400px;
            margin: 1em auto;
        }
        button, select {
            font-size: 1em;
        }
        .controls {
            margin-bottom: 1.5em;
            display: flex;
            gap: 1em;
            align-items: center;
        }
    </style>
    <script>
        document.addEventListener('keydown', function(e) {
            const hotkeys = {'a': 'paper', 'w': 'scissor', 'e': 'stone'};
            if (hotkeys[e.key]) {
                document.getElementById('move-' + hotkeys[e.key]).click();
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>Paper Scissor Stone ML Game</h1>
        <div class="controls">
            <label for="difficulty">Difficulty:</label>
            <select id="difficulty" onchange="setDifficulty()">
                <option value="random">Random</option>
                <option value="frequency">Frequency</option>
                <option value="markov">Markov Chain</option>
                <option value="hybrid">Hybrid</option>
                <option value="decision_tree">Decision Tree</option>
            </select>
            <label for="multiplayer">Multiplayer:</label>
            <input type="checkbox" id="multiplayer" onchange="setMultiplayer()">
            <form id="moveForm" style="display:inline;">
                {% set hotkey_list = hotkeys.keys()|list %}
                {% for move in moves %}
                    <button type="button" name="move" value="{{ move }}" id="move-{{ move }}" class="move-btn" onclick="submitMove('{{ move }}')">
                        <img src="/static/{{ move }}.png" alt="{{ move }}" width="40" height="40" onerror="this.style.display='none';this.insertAdjacentHTML('afterend', '<span style=\'font-size:1.2em;color:#aaa\'>{{ move|capitalize }}</span>')">
                        <span class="hotkey">({{ hotkey_list[loop.index0] }})</span>
                    </button>
                {% endfor %}
            </form>
            <button onclick="resetGame()">Reset Game</button>
        </div>
        <div id="result"></div>
        <div id="stats">
            <h2>Game Statistics</h2>
            <p id="rounds">Rounds played: {{ round }}</p>
            <p id="winStats">Human Wins: {{ stats.human_win }} | Robot Wins: {{ stats.robot_win }} | Ties: {{ stats.tie }}</p>
            <p id="percentStats">Win %: {{ (stats.human_win / round * 100) if round else 0 | round(2) }} | Robot %: {{ (stats.robot_win / round * 100) if round else 0 | round(2) }} | Tie %: {{ (stats.tie / round * 100) if round else 0 | round(2) }}</p>
            <h3>Move Distribution</h3>
            <div class="chart-container"><canvas id="moveChart"></canvas></div>
            <h3>Recent Moves</h3>
            <p id="recentHuman">Human: {{ human_history[-10:] }}</p>
            <p id="recentRobot">Robot: {{ robot_history[-10:] }}</p>
            <h3>Results</h3>
            <p id="recentResult">{{ result_history[-10:] }}</p>
            <h3>ML Performance Metrics</h3>
            <div class="chart-container"><canvas id="resultChart"></canvas></div>
            {% set total = stats.human_win + stats.robot_win + stats.tie %}
            {% set accuracy = (stats.human_win / total * 100) if total else 0 %}
            <p id="humanWinRate">Human Win Rate: {{ accuracy | round(2) }}%</p>
            <p id="robotWinRate">Robot Win Rate: {{ (stats.robot_win / total * 100) if total else 0 | round(2) }}%</p>
            <p id="tieRate">Tie Rate: {{ (stats.tie / total * 100) if total else 0 | round(2) }}%</p>
            <h3>Human Behavior Explanation</h3>
            {% set paper_count = human_history.count('paper') %}
            {% set scissor_count = human_history.count('scissor') %}
            {% set stone_count = human_history.count('stone') %}
            {% set most_common = 'paper' if paper_count >= scissor_count and paper_count >= stone_count else ('scissor' if scissor_count >= stone_count else 'stone') %}
            <p id="mostCommon">Most frequent move: <b>{{ most_common }}</b></p>
            {% if paper_count > scissor_count and paper_count > stone_count %}
                <p id="behavior">You tend to favor <b>paper</b>. The robot may adapt to counter this.</p>
            {% elif scissor_count > paper_count and scissor_count > stone_count %}
                <p id="behavior">You tend to favor <b>scissor</b>. The robot may adapt to counter this.</p>
            {% elif stone_count > paper_count and stone_count > scissor_count %}
                <p id="behavior">You tend to favor <b>stone</b>. The robot may adapt to counter this.</p>
            {% else %}
                <p id="behavior">Your moves are balanced or unpredictable.</p>
            {% endif %}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let moveChart, resultChart;
        function updateCharts(human_history, stats) {
            const moveCounts = [
                human_history.filter(m => m === 'paper').length,
                human_history.filter(m => m === 'scissor').length,
                human_history.filter(m => m === 'stone').length
            ];
            const moveData = {
                labels: ['Paper', 'Scissor', 'Stone'],
                datasets: [{
                    label: 'Human Move Distribution',
                    data: moveCounts,
                    backgroundColor: ['#2196f3', '#e91e63', '#ff9800']
                }]
            };
            if (moveChart) moveChart.destroy();
            moveChart = new Chart(document.getElementById('moveChart'), {
                type: 'bar',
                data: moveData,
                options: { scales: { y: { beginAtZero: true } } }
            });
            const resultData = {
                labels: ['Human Win', 'Robot Win', 'Tie'],
                datasets: [{
                    label: 'Game Results',
                    data: [stats.human_win, stats.robot_win, stats.tie],
                    backgroundColor: ['#4caf50', '#f44336', '#9e9e9e']
                }]
            };
            if (resultChart) resultChart.destroy();
            resultChart = new Chart(document.getElementById('resultChart'), {
                type: 'pie',
                data: resultData
            });
        }
        let currentDifficulty = document.getElementById('difficulty').value;
        let currentMultiplayer = document.getElementById('multiplayer').checked;
        function submitMove(move) {
            let payload = {move, difficulty: currentDifficulty, multiplayer: currentMultiplayer};
            if (currentMultiplayer) {
                let move2 = prompt('Player 2, choose paper, scissor, or stone:');
                if (!['paper','scissor','stone'].includes(move2)) {
                    alert('Invalid move for Player 2.');
                    return;
                }
                payload.move2 = move2;
            }
            fetch('/play', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => updateUI(data));
        }
        function setDifficulty() {
            currentDifficulty = document.getElementById('difficulty').value;
        }
        function setMultiplayer() {
            currentMultiplayer = document.getElementById('multiplayer').checked;
        }
        function resetGame() {
            fetch('/reset', {method: 'POST'})
            .then(res => res.json())
            .then(() => location.reload());
        }
        function updateUI(data) {
            document.getElementById('rounds').textContent = `Rounds played: ${data.round}`;
            document.getElementById('winStats').textContent = `Human Wins: ${data.stats.human_win} | Robot Wins: ${data.stats.robot_win} | Ties: ${data.stats.tie}`;
            document.getElementById('percentStats').textContent = `Win %: ${percent(data.stats.human_win, data.round)} | Robot %: ${percent(data.stats.robot_win, data.round)} | Tie %: ${percent(data.stats.tie, data.round)}`;
            document.getElementById('recentHuman').textContent = `Human: ${data.human_history.slice(-10).join(', ')}`;
            document.getElementById('recentRobot').textContent = `Robot: ${data.robot_history.slice(-10).join(', ')}`;
            document.getElementById('recentResult').textContent = data.result_history.slice(-10).join(', ');
            let total = data.stats.human_win + data.stats.robot_win + data.stats.tie;
            let accuracy = total ? (data.stats.human_win / total * 100).toFixed(2) : 0;
            document.getElementById('humanWinRate').textContent = `Human Win Rate: ${accuracy}%`;
            document.getElementById('robotWinRate').textContent = `Robot Win Rate: ${total ? (data.stats.robot_win / total * 100).toFixed(2) : 0}%`;
            document.getElementById('tieRate').textContent = `Tie Rate: ${total ? (data.stats.tie / total * 100).toFixed(2) : 0}%`;
            // Human behavior
            let paper_count = data.human_history.filter(m => m === 'paper').length;
            let scissor_count = data.human_history.filter(m => m === 'scissor').length;
            let stone_count = data.human_history.filter(m => m === 'stone').length;
            let most_common = 'paper';
            if (scissor_count >= paper_count && scissor_count >= stone_count) most_common = 'scissor';
            else if (stone_count >= paper_count && stone_count >= scissor_count) most_common = 'stone';
            document.getElementById('mostCommon').innerHTML = `Most frequent move: <b>${most_common}</b>`;
            let behavior = '';
            if (paper_count > scissor_count && paper_count > stone_count) behavior = 'You tend to favor <b>paper</b>. The robot may adapt to counter this.';
            else if (scissor_count > paper_count && scissor_count > stone_count) behavior = 'You tend to favor <b>scissor</b>. The robot may adapt to counter this.';
            else if (stone_count > paper_count && stone_count > scissor_count) behavior = 'You tend to favor <b>stone</b>. The robot may adapt to counter this.';
            else behavior = 'Your moves are balanced or unpredictable.';
            document.getElementById('behavior').innerHTML = behavior;
            updateCharts(data.human_history, data.stats);
            if (Array.isArray(data.result)) {
                document.getElementById('result').textContent = `Robot chose: ${data.robot_move}. Results: Player 1: ${data.result[0]}, Player 2: ${data.result[1]}`;
            } else {
                document.getElementById('result').textContent = `Robot chose: ${data.robot_move}. Result: ${data.result}`;
            }
        }
        function percent(val, total) {
            return total ? ((val / total * 100).toFixed(2)) : '0';
        }
        // Initial chart render
        document.addEventListener('DOMContentLoaded', function() {
            var initialHumanHistory = JSON.parse('{{ human_history|tojson|safe }}');
            var initialStats = JSON.parse('{{ stats|tojson|safe }}');
            updateCharts(initialHumanHistory, initialStats);
        });
    </script>
</body>
</html>
