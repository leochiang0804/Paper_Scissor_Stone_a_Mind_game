<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Paper Scissor Stone ML Game</title>
    <style>
        body {
            font-family: 'Quicksand', 'Segoe UI', Arial, sans-serif;
            background: #f6ede6;
            margin: 0;
            padding: 0;
            color: #4b3f2a;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff8f0;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(120, 72, 0, 0.08);
            padding: 36px 40px;
        }
        h1 {
            font-size: 2.3rem;
            margin-bottom: 0.7em;
            color: #a86e3c;
            font-family: 'Quicksand', 'Segoe UI', Arial, sans-serif;
        }
        .move-btn {
            font-size: 1.2em;
            margin: 0.7em;
            padding: 0.7em 1.3em;
            border-radius: 14px;
            border: none;
            background: linear-gradient(90deg, #ffe0b2 0%, #ffd7ba 100%);
            box-shadow: 0 2px 8px rgba(168, 110, 60, 0.07);
            color: #6d4c1c;
            transition: background 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        .move-btn:hover {
            background: linear-gradient(90deg, #ffd7ba 0%, #ffe0b2 100%);
            box-shadow: 0 4px 16px rgba(168, 110, 60, 0.13);
        }
        .hotkey {
            font-size: 0.95em;
            color: #bfa27a;
        }
        #result {
            font-size: 1.15em;
            margin: 1.2em 0;
            color: #a86e3c;
            background: #fff3e0;
            border-radius: 10px;
            padding: 0.7em 1em;
            box-shadow: 0 1px 4px rgba(168, 110, 60, 0.07);
        }
        #stats {
            margin-top: 2.5em;
            padding: 1.5em;
            background: #fbeee0;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(168, 110, 60, 0.06);
        }
        .chart-container {
            max-width: 420px;
            min-width: 320px;
            height: 340px;
            margin: 1.2em auto;
            background: #fff8f0;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(168, 110, 60, 0.04);
            padding: 0.7em 0.5em;
        }
        button, select {
            font-size: 1.05em;
            font-family: inherit;
        }
        .controls {
            margin-bottom: 2em;
            display: flex;
            gap: 1.2em;
            align-items: center;
        }
        select, input[type="checkbox"] {
            border-radius: 8px;
            border: 1px solid #e0c9a6;
            padding: 0.3em 0.7em;
            background: #fff8f0;
            color: #6d4c1c;
        }
        select:focus, input[type="checkbox"]:focus {
            outline: 2px solid #ffd7ba;
        }
        label {
            color: #a86e3c;
            font-weight: 500;
        }
        h2, h3 {
            color: #a86e3c;
            font-family: 'Quicksand', 'Segoe UI', Arial, sans-serif;
        }
        p, span {
            /* max-width: 98vw; */
        }
        
        /* Enhanced Replay Button Styles */
        .btn-replay-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40,167,69,0.4) !important;
        }
        
        .btn-replay-view:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.4) !important;
        }
        
        .btn-developer:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(111,66,193,0.4) !important;
        }
        
        .btn-performance:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(253,126,20,0.4) !important;
        }
    </style>
    <script>
        document.addEventListener('keydown', function(e) {
            console.log('Key pressed:', e.key);
            if (e.key === 'a') {
                console.log('A pressed - calling submitMove with paper');
                submitMove('paper');
            }
            if (e.key === 'w') {
                console.log('W pressed - calling submitMove with scissor');
                submitMove('scissor');
            }
            if (e.key === 'd') {
                console.log('D pressed - calling submitMove with stone');
                submitMove('stone');
            }
        });
    </script>
</head>
<body>
    <div class="container" style="max-width:1400px;">
        <h1>Paper Scissor Stone ML Game</h1>
        
        <!-- Enhanced Replay Controls - Prominent Location -->
        <div class="game-controls" style="text-align: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="margin-bottom: 10px; font-weight: 600; color: #495057; font-size: 1.1em;">🎮 Game Controls</div>
            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button onclick="saveCurrentReplay()" class="btn-replay-save" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(40,167,69,0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                    💾 Save Current Replay
                </button>
                <button onclick="window.open('/replay/dashboard', '_blank')" class="btn-replay-view" style="background: linear-gradient(135deg, #007bff 0%, #6610f2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,123,255,0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                    🎬 View All Replays
                </button>
                <button onclick="window.open('/developer', '_blank')" class="btn-developer" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(111,66,193,0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                    🔧 Developer Console
                </button>
                <button onclick="window.open('/performance', '_blank')" class="btn-performance" style="background: linear-gradient(135deg, #fd7e14 0%, #dc3545 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(253,126,20,0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                    ⚡ Performance Dashboard
                </button>
            </div>
        </div>
        
        <div id="selection-window" style="display:flex; justify-content:center; align-items:center; gap:3em; margin-bottom:2em;">
            <div id="human-selection" style="position:relative; text-align:center; min-width:180px; min-height:160px; background:#fff8f0; border-radius:16px; box-shadow:0 2px 8px #e0c9a6; padding:1em 0.5em 0.5em 0.5em;">
                <div style="font-weight:600; color:#a86e3c;">Human Choice</div>
                <img id="human-choice-img" src="/static/paper.png" alt="Human Choice" width="80" height="80" style="display:none; margin-top:0.5em; border-radius:12px; box-shadow:0 2px 8px #e0c9a6;">
                <div id="human-choice-label" style="margin-top:0.5em; font-size:1.1em; color:#6d4c1c;"></div>
                <div id="human-winner-overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; border-radius:12px; background:rgba(76,175,80,0.18); border:2px solid #4caf50; pointer-events:none;"></div>
                <div id="human-winner-badge" style="display:none; position:absolute; top:10px; right:10px; background:#4caf50; color:#fff; font-weight:700; padding:4px 12px; border-radius:10px; font-size:1em; box-shadow:0 2px 8px #4caf50; z-index:3;">Winner!</div>
            </div>
            <div id="robot-selection" style="position:relative; text-align:center; min-width:180px; min-height:160px; background:#fff8f0; border-radius:16px; box-shadow:0 2px 8px #e0c9a6; padding:1em 0.5em 0.5em 0.5em;">
                <div style="font-weight:600; color:#a86e3c;">Robot Choice</div>
                <img id="robot-choice-img" src="/static/paper.png" alt="Robot Choice" width="80" height="80" style="display:none; margin-top:0.5em; border-radius:12px; box-shadow:0 2px 8px #e0c9a6;">
                <div id="robot-choice-label" style="margin-top:0.5em; font-size:1.1em; color:#6d4c1c;"></div>
                <div id="confidence-indicator" style="margin-top:0.3em; font-size:0.9em; color:#888; font-style:italic;"></div>
                <div id="robot-winner-overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; border-radius:12px; background:rgba(33,150,243,0.18); border:2px solid #2196f3; pointer-events:none;"></div>
                <div id="robot-winner-badge" style="display:none; position:absolute; top:10px; right:10px; background:#2196f3; color:#fff; font-weight:700; padding:4px 12px; border-radius:10px; font-size:1em; box-shadow:0 2px 8px #2196f3; z-index:3;">Winner!</div>
            </div>
        </div>
        <div class="controls" style="position:absolute; top:32px; right:32px; z-index:10; background:#fff8f0; border-radius:16px; box-shadow:0 2px 8px #e0c9a6; padding:1.2em 1.5em; display:flex; flex-direction:column; align-items:flex-end; gap:1em; min-width:320px;">
            <label for="difficulty">Difficulty:</label>
            <select id="difficulty" onchange="setDifficulty()">
                <option value="random" {% if default_difficulty == 'random' %}selected{% endif %}>Random</option>
                <option value="frequency" {% if default_difficulty == 'frequency' %}selected{% endif %}>Frequency</option>
                <option value="markov" {% if default_difficulty == 'markov' %}selected{% endif %}>Markov Chain</option>
                <option value="enhanced" {% if default_difficulty == 'enhanced' %}selected{% endif %}>Enhanced ML</option>
                <option value="lstm" {% if default_difficulty == 'lstm' %}selected{% endif %}>🧠 LSTM Neural</option>
                <option value="hybrid" {% if default_difficulty == 'hybrid' %}selected{% endif %}>Hybrid</option>
                <option value="decision_tree" {% if default_difficulty == 'decision_tree' %}selected{% endif %}>Decision Tree</option>
            </select>
            
            <label for="personality">AI Personality:</label>
            <select id="personality" onchange="setPersonality()">
                <option value="neutral">🤖 Neutral (Standard)</option>
                <optgroup label="🎭 Advanced Personalities">
                    <option value="berserker">⚔️ The Berserker (Ultra Aggressive)</option>
                    <option value="guardian">🛡️ The Guardian (Defensive)</option>
                    <option value="chameleon">🦎 The Chameleon (Adaptive)</option>
                    <option value="professor">🎓 The Professor (Analytical)</option>
                    <option value="wildcard">🎲 The Wildcard (Unpredictable)</option>
                    <option value="mirror">🪞 The Mirror (Mimicking)</option>
                </optgroup>
            </select>
            
            <label for="multiplayer">Multiplayer:</label>
            <input type="checkbox" id="multiplayer" onchange="setMultiplayer()">
            <form id="moveForm" style="display:inline;">
                {% set hotkey_list = ['a', 'w', 'd'] %}
                {% for move in moves %}
                    <button type="button" name="move" value="{{ move }}" id="move-{{ move }}" class="move-btn" onclick="submitMove('{{ move }}')">
                        <img src="/static/{{ move }}.png" alt="{{ move }}" width="40" height="40" onerror="this.style.display='none';this.insertAdjacentHTML('afterend', '<span style=\'font-size:1.2em;color:#aaa\'>{{ move|capitalize }}</span>')">
                        <span class="hotkey">({{ hotkey_list[loop.index0] }})</span>
                    </button>
                {% endfor %}
            </form>
            <button onclick="resetGame()">Reset Game</button>
        </div>
        <div style="display: flex; gap: 2em; align-items: flex-start; justify-content:center; margin-bottom:2em;">
            <div class="chart-container" style="flex:1; min-width:320px;">
                <canvas id="moveChart" height="260"></canvas>
            </div>
            <div class="chart-container" style="flex:1; min-width:320px;">
                <canvas id="resultChart" height="180"></canvas>
                <div id="result-legend" style="text-align:center; margin-top:0.5em; font-size:1.08em;">
                    <span style="display:inline-block; width:16px; height:16px; background:#4caf50; border-radius:3px; margin-right:8px; vertical-align:middle;"></span> Human Win
                    <span style="display:inline-block; width:16px; height:16px; background:#f44336; border-radius:3px; margin-left:18px; margin-right:8px; vertical-align:middle;"></span> Robot Win
                    <span style="display:inline-block; width:16px; height:16px; background:#9e9e9e; border-radius:3px; margin-left:18px; margin-right:8px; vertical-align:middle;"></span> Tie
                </div>
            </div>
            <div class="chart-container" style="flex:1; min-width:320px;">
                <canvas id="roundChart" height="260"></canvas>
                <div style="text-align:center; margin-top:0.5em; font-size:1em;">
                    <span style="color:#2196f3; font-weight:600;">Human</span> |
                    <span style="color:#e91e63; font-weight:600;">Robot</span>
                </div>
            </div>
        </div>
        
        <!-- New Strategy Timeline Section -->
        <div class="chart-container" style="width:100%; max-width:1200px; margin:2em auto;">
            <h3 style="text-align:center; color:#a86e3c; margin-bottom:1em;">Strategy Timeline & Analysis</h3>
            <div id="current-strategy-display" style="text-align:center; margin-bottom:1em; padding:0.8em; background:#fff3e0; border-radius:10px; border-left:4px solid #ff9800;">
                <strong>Current Strategy: </strong><span id="current-strategy-text" style="color:#e65100; font-weight:600;">Analyzing...</span>
                <span id="strategy-confidence" style="margin-left:1em; color:#666; font-size:0.9em;"></span>
            </div>
            <canvas id="strategyTimeline" height="150"></canvas>
            <div id="timeline-legend" style="text-align:center; margin-top:1em; font-size:0.95em; color:#666;">
                <div style="display:inline-block; margin:0 1em;">
                    <span style="display:inline-block; width:16px; height:16px; background:#ff5722; border-radius:3px; margin-right:6px; vertical-align:middle;"></span> Repeater
                </div>
                <div style="display:inline-block; margin:0 1em;">
                    <span style="display:inline-block; width:16px; height:16px; background:#2196f3; border-radius:3px; margin-right:6px; vertical-align:middle;"></span> Cycler
                </div>
                <div style="display:inline-block; margin:0 1em;">
                    <span style="display:inline-block; width:16px; height:16px; background:#4caf50; border-radius:3px; margin-right:6px; vertical-align:middle;"></span> Balanced
                </div>
                <div style="display:inline-block; margin:0 1em;">
                    <span style="display:inline-block; width:16px; height:16px; background:#ff9800; border-radius:3px; margin-right:6px; vertical-align:middle;"></span> Biased
                </div>
                <div style="display:inline-block; margin:0 1em;">
                    <span style="display:inline-block; width:16px; height:16px; background:#9c27b0; border-radius:3px; margin-right:6px; vertical-align:middle;"></span> Anti-Repeater
                </div>
                <div style="display:inline-block; margin:0 1em;">
                    <span style="display:inline-block; width:16px; height:16px; background:#607d8b; border-radius:3px; margin-right:6px; vertical-align:middle;"></span> Warming Up
                </div>
            </div>
            <div id="change-points-summary" style="margin-top:1em; padding:0.8em; background:#e8f5e8; border-radius:8px; border-left:4px solid #4caf50;">
                <strong>Strategy Changes Detected: </strong><span id="change-count">0</span>
                <div id="recent-changes" style="margin-top:0.5em; font-size:0.9em; color:#2e7d32;"></div>
            </div>
        </div>
        
        <!-- New Coaching Tips Section -->
        <div class="chart-container" style="width:100%; max-width:1200px; margin:2em auto;">
            <h3 style="text-align:center; color:#a86e3c; margin-bottom:1em;">🎓 AI Coach - Personalized Tips</h3>
            <div style="display:flex; gap:1.5em; align-items:flex-start;">
                <div style="flex:2; background:#fff3e0; border-radius:12px; padding:1.5em; border-left:4px solid #ff9800;">
                    <h4 style="color:#e65100; margin-top:0; display:flex; align-items:center;">
                        💡 Your Strategy Tips
                        <button id="refresh-tips-btn" onclick="refreshCoachingTips()" style="margin-left:auto; padding:0.3em 0.8em; background:#ff9800; color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.8em;">
                            🔄 Get New Tips
                        </button>
                    </h4>
                    <div id="coaching-tips-list" style="line-height:1.6;">
                        <p style="color:#666; font-style:italic;">Play a few rounds to get personalized coaching tips!</p>
                    </div>
                </div>
                <div style="flex:1; background:#e8f5e8; border-radius:12px; padding:1.5em; border-left:4px solid #4caf50;">
                    <h4 style="color:#2e7d32; margin-top:0;">🧪 Experiments to Try</h4>
                    <div id="experiments-list" style="line-height:1.5;">
                        <p style="color:#666; font-style:italic;">Suggested strategies will appear here!</p>
                    </div>
                </div>
            </div>
            <div id="insights-summary" style="margin-top:1em; padding:1em; background:#f3e5f5; border-radius:8px; border-left:4px solid #9c27b0; display:none;">
                <h4 style="color:#6a1b9a; margin-top:0;">📊 Pattern Analysis</h4>
                <div id="insights-content" style="font-size:0.9em; color:#4a148c;"></div>
            </div>
        </div>
        <div id="stats" style="margin-top:2.5em;">
            <h2>Game Statistics</h2>
            <p id="rounds">Rounds played: {{ round }}</p>
            <p id="winStats">Human Wins: {{ stats.human_win }} | Robot Wins: {{ stats.robot_win }} | Ties: {{ stats.tie }}</p>
            <p id="percentStats">Win %: {{ (stats.human_win / round * 100) if round else 0 | round(2) }} | Robot %: {{ (stats.robot_win / round * 100) if round else 0 | round(2) }} | Tie %: {{ (stats.tie / round * 100) if round else 0 | round(2) }}</p>
            <h3>Recent Moves</h3>
            <p id="recentHuman">Human: {{ human_history[-10:] }}</p>
            <p id="recentRobot">Robot: {{ robot_history[-10:] }}</p>
            <h3>Results</h3>
            <p id="recentResult">{{ result_history[-10:] }}</p>
            <h3>ML Performance Metrics</h3>
            <div id="mlAccuracyMetrics" style="margin-bottom:1em;">
                <b>Prediction Accuracy by Method:</b>
                <ul style="list-style:none; padding-left:0;">
                    <li>Random: <span id="acc-random">-</span>%</li>
                    <li>Frequency: <span id="acc-frequency">-</span>%</li>
                    <li>Markov Chain: <span id="acc-markov">-</span>%</li>
                    <li>Hybrid: <span id="acc-hybrid">-</span>%</li>
                    <li>Decision Tree: <span id="acc-decision_tree">-</span>%</li>
                    <li>Enhanced ML: <span id="acc-enhanced">-</span>%</li>
                    <li>LSTM Neural: <span id="acc-lstm">-</span>%</li>
                </ul>
            </div>
            {% set total = stats.human_win + stats.robot_win + stats.tie %}
            {% set accuracy = (stats.human_win / total * 100) if total else 0 %}
            <p id="humanWinRate">Human Win Rate: {{ accuracy | round(2) }}%</p>
            <p id="robotWinRate">Robot Win Rate: {{ (stats.robot_win / total * 100) if total else 0 | round(2) }}%</p>
            <p id="tieRate">Tie Rate: {{ (stats.tie / total * 100) if total else 0 | round(2) }}%</p>
            <h3>Human Behavior Explanation</h3>
            {% set paper_count = human_history.count('paper') %}
            {% set scissor_count = human_history.count('scissor') %}
            {% set stone_count = human_history.count('stone') %}
            {% set most_common = 'paper' if paper_count >= scissor_count and paper_count >= stone_count else ('scissor' if scissor_count >= stone_count else 'stone') %}
            <p id="mostCommon">Most frequent move: <b>{{ most_common }}</b></p>
            {% if paper_count > scissor_count and paper_count > stone_count %}
                <p id="behavior">You tend to favor <b>paper</b>. The robot may adapt to counter this.</p>
            {% elif scissor_count > paper_count and scissor_count > stone_count %}
                <p id="behavior">You tend to favor <b>scissor</b>. The robot may adapt to counter this.</p>
            {% elif stone_count > paper_count and stone_count > scissor_count %}
                <p id="behavior">You tend to favor <b>stone</b>. The robot may adapt to counter this.</p>
            {% else %}
                <p id="behavior">Your moves are balanced or unpredictable.</p>
            {% endif %}
        </div>
        <!-- Debug outputs moved to bottom -->
        <div id="debug" style="margin-top:2em;">
            <h3>Debug: Moves by Round (raw data)</h3>
            <table id="roundHistoryTable" style="width:100%;margin-bottom:1em;background:#fff8f0;border-radius:8px;box-shadow:0 1px 4px #e0c9a6;">
                <thead><tr><th>Round</th><th>Human</th><th>Robot</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    let moveChart, resultChart, roundChart, strategyTimeline;
    
    // Strategy color mapping
    const strategyColors = {
        'repeater': '#ff5722',
        'cycler': '#2196f3', 
        'balanced': '#4caf50',
        'biased': '#ff9800',
        'stone-biased': '#ff9800',
        'paper-biased': '#ff9800', 
        'scissor-biased': '#ff9800',
        'anti-repeater': '#9c27b0',
        'warming up': '#607d8b',
        'unknown': '#cccccc'
    };
    
    function updateCharts(human_history, stats, round_history) {
        // Defensive: ensure round_history is valid
        if (!Array.isArray(round_history) || round_history.length === 0) {
            round_history = [];
        }
        // Move distribution using round_history (bar)
        const moveMap = {'paper': 0, 'scissor': 1, 'stone': 2};
        const roundLabels = ['Paper', 'Scissor', 'Stone'];
        const humanMoves = round_history.map(r => r.human);
        const moveCounts = [
            humanMoves.filter(m => m === 'paper').length,
            humanMoves.filter(m => m === 'scissor').length,
            humanMoves.filter(m => m === 'stone').length
        ];
        const moveData = {
            labels: roundLabels,
            datasets: [{
                label: 'Human Move Distribution',
                data: moveCounts,
                backgroundColor: ['#2196f3', '#e91e63', '#ff9800']
            }]
        };
        if (moveChart) moveChart.destroy();
        moveChart = new Chart(document.getElementById('moveChart'), {
            type: 'bar',
            data: moveData,
            options: { scales: { y: { beginAtZero: true } } }
        });

        // Moves by round chart (scatter) for clearer visualization
        if (roundChart) roundChart.destroy();
        const humanPoints = round_history.map(r => ({x: r.round, y: moveMap[r.human]}));
        const robotPoints = round_history.map(r => ({x: r.round, y: moveMap[r.robot]}));
        roundChart = new Chart(document.getElementById('roundChart'), {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Human',
                        data: humanPoints,
                        borderColor: '#2196f3',
                        backgroundColor: '#2196f3',
                        pointRadius: 6,
                        pointStyle: 'circle',
                        showLine: false
                    },
                    {
                        label: 'Robot',
                        data: robotPoints,
                        borderColor: '#e91e63',
                        backgroundColor: '#e91e63',
                        pointRadius: 6,
                        pointStyle: 'triangle',
                        showLine: false
                    }
                ]
            },
            options: {
                scales: {
                    x: {title: {display: true, text: 'Round'}, type: 'linear', min: 1},
                    y: {
                        title: {display: true, text: 'Move'},
                        type: 'category',
                        labels: roundLabels,
                        ticks: {
                            callback: function(value, index) { return roundLabels[value]; },
                            stepSize: 1
                        },
                        min: 0,
                        max: 2
                    }
                },
                plugins: {
                    legend: {display: true, position: 'bottom'},
                    title: {display: true, text: 'Moves by Round (Scatter)'}
                }
            }
        });

        // Pie chart for results
        const resultData = {
            labels: ['Human Win', 'Robot Win', 'Tie'],
            datasets: [{
                label: 'Game Results',
                data: [stats.human_win, stats.robot_win, stats.tie],
                backgroundColor: ['#4caf50', '#f44336', '#9e9e9e']
            }]
        };
        if (resultChart) resultChart.destroy();
        resultChart = new Chart(document.getElementById('resultChart'), {
            type: 'pie',
            data: resultData
        });
    }
    
    function updateStrategyTimeline(strategyHistory, changePoints) {
        // Create strategy timeline chart
        if (strategyTimeline) strategyTimeline.destroy();
        
        // Build datasets for strategy timeline
        const datasets = [];
        const strategyData = [];
        
        // If we have enough data, show strategy progression
        if (strategyHistory && strategyHistory.length > 0) {
            strategyHistory.forEach((strategy, index) => {
                const round = index + 1;
                const color = strategyColors[strategy] || strategyColors['unknown'];
                strategyData.push({
                    x: round,
                    y: 1,
                    strategy: strategy,
                    backgroundColor: color,
                    borderColor: color
                });
            });
            
            datasets.push({
                label: 'Strategy Over Time',
                data: strategyData,
                backgroundColor: strategyData.map(d => d.backgroundColor),
                borderColor: strategyData.map(d => d.borderColor),
                pointRadius: 8,
                pointHoverRadius: 10,
                showLine: false,
                pointStyle: 'rect'
            });
        }
        
        // Add change point markers
        if (changePoints && changePoints.length > 0) {
            const changePointData = changePoints.map(cp => ({
                x: cp.round || cp.move_index || 0,
                y: 1,
                description: cp.description || 'Strategy change detected'
            }));
            
            datasets.push({
                label: 'Strategy Changes',
                data: changePointData,
                backgroundColor: '#e53935',
                borderColor: '#d32f2f',
                pointRadius: 12,
                pointHoverRadius: 15,
                showLine: false,
                pointStyle: 'triangle'
            });
        }
        
        strategyTimeline = new Chart(document.getElementById('strategyTimeline'), {
            type: 'scatter',
            data: { datasets: datasets },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Round' },
                        type: 'linear',
                        min: 1,
                        suggestedMax: Math.max(10, strategyHistory ? strategyHistory.length : 10)
                    },
                    y: {
                        display: false,
                        min: 0.5,
                        max: 1.5
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: { 
                        display: true, 
                        text: 'Your Strategy Evolution',
                        font: { size: 14, weight: 'bold' },
                        color: '#a86e3c'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.label === 'Strategy Changes') {
                                    return context.raw.description;
                                } else {
                                    return `Round ${context.raw.x}: ${context.raw.strategy}`;
                                }
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'nearest'
                }
            }
        });
    }
        let currentDifficulty = 'enhanced'; // Default value
        let currentPersonality = 'neutral'; // Default personality
        let currentMultiplayer = false; // Default value
        
        // Initialize values when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const difficultySelect = document.getElementById('difficulty');
            const multiplayerCheck = document.getElementById('multiplayer');
            if (difficultySelect) currentDifficulty = difficultySelect.value;
            if (multiplayerCheck) currentMultiplayer = multiplayerCheck.checked;
        });
        
        function submitMove(move) {
            console.log('submitMove called with:', move);
            
            // Use safe default values
            const difficulty = currentDifficulty || 'enhanced';
            const multiplayer = currentMultiplayer || false;
            
            let payload = {move, difficulty, multiplayer, personality: currentPersonality};
            
            if (multiplayer) {
                let move2 = prompt('Player 2, choose paper, scissor, or stone:');
                if (!['paper','scissor','stone'].includes(move2)) {
                    alert('Invalid move for Player 2.');
                    return;
                }
                payload.move2 = move2;
            }
            
            console.log('Sending payload:', payload);
            
            fetch('/play', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => {
                console.log('Received response status:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('Received data:', data);
                updateUI(data);
            })
            .catch(error => {
                console.error('Error in submitMove:', error);
                alert('Error making move: ' + error.message);
            });
        }
        function setDifficulty() {
            currentDifficulty = document.getElementById('difficulty').value;
        }
        function setPersonality() {
            currentPersonality = document.getElementById('personality').value;
            // Show personality description
            const descriptions = {
                'neutral': 'Standard balanced AI behavior',
                'berserker': 'Ultra-aggressive, high-risk playstyle that targets weaknesses ruthlessly',
                'guardian': 'Highly defensive, prioritizes not losing over winning. Patient and calculating',
                'chameleon': 'Highly adaptive, changes strategy based on opponent. Unpredictable',
                'professor': 'Analytical and methodical. Uses complex patterns and psychological insights',
                'wildcard': 'Completely unpredictable and chaotic. Thrives on confusion',
                'mirror': 'Reflects and learns from opponent style. Becomes more similar over time'
            };
            
            // Create or update personality info display
            let infoDiv = document.getElementById('personality-info');
            if (!infoDiv) {
                infoDiv = document.createElement('div');
                infoDiv.id = 'personality-info';
                infoDiv.style.cssText = 'margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em; color: #6c757d; border-left: 3px solid #007bff;';
                document.getElementById('personality').parentNode.insertBefore(infoDiv, document.getElementById('personality').nextSibling);
            }
            infoDiv.textContent = descriptions[currentPersonality] || 'Standard AI behavior';
        }
        function setMultiplayer() {
            currentMultiplayer = document.getElementById('multiplayer').checked;
        }
        function resetGame() {
            fetch('/reset', {method: 'POST'})
            .then(res => res.json())
            .then(() => location.reload());
        }
        
        function saveCurrentReplay() {
            const name = prompt('Enter a name for this replay:', 'Game Session ' + new Date().toLocaleString());
            if (name) {
                const notes = prompt('Enter any notes (optional):', '');
                const formData = new FormData();
                formData.append('name', name);
                formData.append('notes', notes || '');
                
                fetch('/replay/save', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(`✅ Replay saved successfully!\nSession ID: ${data.session_id}\nTotal rounds: ${data.total_rounds}`);
                    } else {
                        alert(`❌ Failed to save replay: ${data.message}`);
                    }
                })
                .catch(err => {
                    alert('❌ Error saving replay: ' + err.message);
                });
            }
        }
        function updateUI(data) {
            // Debug: show round_history table
            const tableBody = document.querySelector('#roundHistoryTable tbody');
            tableBody.innerHTML = '';
            if (Array.isArray(data.round_history)) {
                data.round_history.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.round}</td><td>${r.human}</td><td>${r.robot}</td>`;
                    tableBody.appendChild(tr);
                });
            }
            document.getElementById('rounds').textContent = `Rounds played: ${data.round}`;
            document.getElementById('winStats').textContent = `Human Wins: ${data.stats.human_win} | Robot Wins: ${data.stats.robot_win} | Ties: ${data.stats.tie}`;
            document.getElementById('percentStats').textContent = `Win %: ${percent(data.stats.human_win, data.round)} | Robot %: ${percent(data.stats.robot_win, data.round)} | Tie %: ${percent(data.stats.tie, data.round)}`;
            document.getElementById('recentHuman').textContent = `Human: ${data.human_history.slice(-10).join(', ')}`;
            document.getElementById('recentRobot').textContent = `Robot: ${data.robot_history.slice(-10).join(', ')}`;
            document.getElementById('recentResult').textContent = data.result_history.slice(-10).join(', ');
            let total = data.stats.human_win + data.stats.robot_win + data.stats.tie;
            let accuracy = total ? (data.stats.human_win / total * 100).toFixed(2) : 0;
            document.getElementById('humanWinRate').textContent = `Human Win Rate: ${accuracy}%`;
            document.getElementById('robotWinRate').textContent = `Robot Win Rate: ${total ? (data.stats.robot_win / total * 100).toFixed(2) : 0}%`;
            document.getElementById('tieRate').textContent = `Tie Rate: ${total ? (data.stats.tie / total * 100).toFixed(2) : 0}%`;
            // ML accuracy metrics
            if (data.accuracy) {
                for (const key of ['random','frequency','markov','hybrid','decision_tree','enhanced','lstm']) {
                    const elem = document.getElementById('acc-' + key);
                    if (elem) {
                        elem.textContent = (data.accuracy[key] !== null && data.accuracy[key] !== undefined) ? data.accuracy[key] : '-';
                    }
                }
            }
            
            // Confidence indicator
            if (data.confidence !== undefined) {
                const confidenceElem = document.getElementById('confidence-indicator');
                if (confidenceElem) {
                    const confPercent = (data.confidence * 100).toFixed(1);
                    let confLevel = 'Low';
                    if (data.confidence > 0.7) confLevel = 'High';
                    else if (data.confidence > 0.5) confLevel = 'Medium';
                    confidenceElem.textContent = `Confidence: ${confLevel} (${confPercent}%)`;
                }
            }
            
            // Update strategy display
            if (data.current_strategy) {
                const strategyElem = document.getElementById('current-strategy-text');
                if (strategyElem) {
                    const strategy = data.current_strategy;
                    const strategyDisplay = strategy.charAt(0).toUpperCase() + strategy.slice(1);
                    strategyElem.textContent = strategyDisplay;
                    strategyElem.style.color = strategyColors[strategy] || '#666';
                }
            }
            
            // Update change points summary
            if (data.change_points) {
                const changeCountElem = document.getElementById('change-count');
                const recentChangesElem = document.getElementById('recent-changes');
                
                if (changeCountElem) {
                    changeCountElem.textContent = data.change_points.length;
                }
                
                if (recentChangesElem && data.change_points.length > 0) {
                    const recent = data.change_points.slice(-3); // Show last 3 changes
                    const changeText = recent.map(cp => 
                        `Round ${cp.round || cp.move_index}: ${cp.description}`
                    ).join('<br>');
                    recentChangesElem.innerHTML = changeText;
                } else if (recentChangesElem) {
                    recentChangesElem.innerHTML = 'No strategy changes detected yet.';
                }
            }
            
            // Build strategy history for timeline
            const strategyHistory = [];
            if (data.round_history && data.round_history.length > 0) {
                // Create a simplified strategy history based on available data
                // This is a placeholder - in a full implementation, we'd track strategy per round
                const currentStrategy = data.current_strategy || 'unknown';
                for (let i = 0; i < data.round_history.length; i++) {
                    // For now, use current strategy for recent rounds
                    // In practice, you'd want to track this per round
                    if (i < data.round_history.length - 5) {
                        strategyHistory.push('warming up');
                    } else {
                        strategyHistory.push(currentStrategy);
                    }
                }
            }
            
            // Update strategy timeline
            updateStrategyTimeline(strategyHistory, data.change_points || []);
            
            // Auto-refresh coaching tips every 5 rounds
            if (data.round > 0 && data.round % 5 === 0) {
                refreshCoachingTips();
            }
        }
        
        function refreshCoachingTips() {
            fetch('/coaching')
            .then(res => res.json())
            .then(data => updateCoachingTips(data))
            .catch(err => console.log('Coaching tips unavailable:', err));
        }
        
        function updateCoachingTips(coachingData) {
            const tipsContainer = document.getElementById('coaching-tips-list');
            const experimentsContainer = document.getElementById('experiments-list');
            const insightsContainer = document.getElementById('insights-content');
            const insightsSummary = document.getElementById('insights-summary');
            
            // Update tips
            if (coachingData.coaching_tips && coachingData.coaching_tips.length > 0) {
                const tipsHtml = coachingData.coaching_tips.map((tip, index) => 
                    `<div style="margin-bottom:0.8em; padding:0.6em; background:rgba(255,152,0,0.1); border-radius:6px;">
                        <strong>${index + 1}.</strong> ${tip}
                    </div>`
                ).join('');
                tipsContainer.innerHTML = tipsHtml;
            } else {
                tipsContainer.innerHTML = '<p style="color:#666; font-style:italic;">Keep playing to get personalized tips!</p>';
            }
            
            // Update experiments
            if (coachingData.experiments && coachingData.experiments.length > 0) {
                const experimentsHtml = coachingData.experiments.map(exp => 
                    `<div style="margin-bottom:1em; padding:0.8em; background:rgba(76,175,80,0.1); border-radius:6px;">
                        <strong style="color:#2e7d32;">${exp.name}</strong><br>
                        <small style="color:#388e3c;">${exp.description}</small><br>
                        <em style="font-size:0.85em; color:#4caf50;">${exp.strategy}</em>
                    </div>`
                ).join('');
                experimentsContainer.innerHTML = experimentsHtml;
            } else {
                experimentsContainer.innerHTML = '<p style="color:#666; font-style:italic;">Experiment suggestions coming soon!</p>';
            }
            
            // Update insights (optional)
            if (coachingData.insights && Object.keys(coachingData.insights).length > 0) {
                const insights = coachingData.insights;
                let insightsHtml = '';
                
                if (insights.predictability !== undefined) {
                    const predPercent = (insights.predictability * 100).toFixed(1);
                    insightsHtml += `<p><strong>Predictability:</strong> ${predPercent}% - `;
                    insightsHtml += insights.predictability > 0.6 ? 'Too predictable!' : 'Good unpredictability';
                    insightsHtml += '</p>';
                }
                
                if (insights.pattern_type) {
                    insightsHtml += `<p><strong>Pattern Type:</strong> ${insights.pattern_type.replace('_', ' ')}</p>`;
                }
                
                if (insights.recent_performance) {
                    const winRate = (insights.recent_performance.win_rate * 100).toFixed(1);
                    insightsHtml += `<p><strong>Recent Win Rate:</strong> ${winRate}%</p>`;
                }
                
                if (insightsHtml) {
                    insightsContainer.innerHTML = insightsHtml;
                    insightsSummary.style.display = 'block';
                } else {
                    insightsSummary.style.display = 'none';
                }
            } else {
                insightsSummary.style.display = 'none';
            }
        }
            // Winner highlight logic
            let humanMove = data.human_history.length ? data.human_history[data.human_history.length-1] : null;
            let robotMove = data.robot_move;
            let humanImg = document.getElementById('human-choice-img');
            let robotImg = document.getElementById('robot-choice-img');
            let humanLabel = document.getElementById('human-choice-label');
            let robotLabel = document.getElementById('robot-choice-label');
            if (humanMove) {
                humanImg.src = `/static/${humanMove}.png`;
                humanImg.style.display = '';
                humanLabel.textContent = humanMove.charAt(0).toUpperCase() + humanMove.slice(1);
            } else {
                humanImg.style.display = 'none';
                humanLabel.textContent = '';
            }
            if (robotMove) {
                robotImg.src = `/static/${robotMove}.png`;
                robotImg.style.display = '';
                robotLabel.textContent = robotMove.charAt(0).toUpperCase() + robotMove.slice(1);
            } else {
                robotImg.style.display = 'none';
                robotLabel.textContent = '';
            }
            // Winner overlays and badges
            const humanOverlay = document.getElementById('human-winner-overlay');
            const robotOverlay = document.getElementById('robot-winner-overlay');
            const humanBadge = document.getElementById('human-winner-badge');
            const robotBadge = document.getElementById('robot-winner-badge');
            humanOverlay.style.display = 'none';
            robotOverlay.style.display = 'none';
            humanBadge.style.display = 'none';
            robotBadge.style.display = 'none';
            humanOverlay.style.background = 'rgba(76,175,80,0.18)';
            humanOverlay.style.border = '2px solid #4caf50';
            robotOverlay.style.background = 'rgba(33,150,243,0.18)';
            robotOverlay.style.border = '2px solid #2196f3';
            let lastResult = Array.isArray(data.result) ? data.result[data.result.length-1] : data.result;
            if (lastResult === 'human') {
                humanOverlay.style.display = '';
                humanBadge.style.display = '';
            } else if (lastResult === 'robot') {
                robotOverlay.style.display = '';
                robotBadge.style.display = '';
            } else if (lastResult === 'tie') {
                humanOverlay.style.display = '';
                robotOverlay.style.display = '';
                humanOverlay.style.background = 'rgba(158,158,158,0.18)';
                humanOverlay.style.border = '2px solid #9e9e9e';
                robotOverlay.style.background = 'rgba(158,158,158,0.18)';
                robotOverlay.style.border = '2px solid #9e9e9e';
            }
            // Human behavior
            let paper_count = data.human_history.filter(m => m === 'paper').length;
            let scissor_count = data.human_history.filter(m => m === 'scissor').length;
            let stone_count = data.human_history.filter(m => m === 'stone').length;
            let most_common = 'paper';
            if (scissor_count >= paper_count && scissor_count >= stone_count) most_common = 'scissor';
            else if (stone_count >= paper_count && stone_count >= scissor_count) most_common = 'stone';
            document.getElementById('mostCommon').innerHTML = `Most frequent move: <b>${most_common}</b>`;
            let behavior = '';
            if (paper_count > scissor_count && paper_count > stone_count) behavior = 'You tend to favor <b>paper</b>. The robot may adapt to counter this.';
            else if (scissor_count > paper_count && scissor_count > stone_count) behavior = 'You tend to favor <b>scissor</b>. The robot may adapt to counter this.';
            else if (stone_count > paper_count && stone_count > scissor_count) behavior = 'You tend to favor <b>stone</b>. The robot may adapt to counter this.';
            else behavior = 'Your moves are balanced or unpredictable.';
            document.getElementById('behavior').innerHTML = behavior;
            updateCharts(data.human_history, data.stats, data.round_history);
            // Remove textual result info
            document.getElementById('result').textContent = '';
        }
        function percent(val, total) {
            return total ? ((val / total * 100).toFixed(2)) : '0';
        }
        // Initial chart render using /history endpoint - COMPLETELY DISABLED FOR DEBUGGING
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - starting minimal initialization');
            
            // SKIP ALL CHART AND DATA PROCESSING FOR NOW
            console.log('Skipping all chart initialization to test basic functionality');
            console.log('Page should be ready for input now');
        });
    </script>
</body>
</html>
